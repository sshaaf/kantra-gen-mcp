name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2)'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Get latest successful build run
        id: get-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list --branch main --workflow build.yml --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "No successful build found on main branch"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found successful run: $RUN_ID"

      - name: Download artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts
          gh run download ${{ steps.get-run.outputs.run_id }} --dir artifacts

      - name: Prepare release assets
        run: |
          cd artifacts
          cp kantra-rules-gen-linux-x64/kantra-gen-mcp-*-runner kantra-rules-gen-linux-x64.bin
          cp kantra-rules-gen-macos/kantra-gen-mcp-*-runner kantra-rules-gen-macos-arm64.bin
          cp kantra-rules-gen-windows-x64/kantra-gen-mcp-*-runner.exe kantra-rules-gen-windows-x64.exe
          cp kantra-rules-gen-uber-jar/kantra-gen-mcp-*-runner.jar kantra-rules-gen.jar
          ls -la *.bin *.exe *.jar

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ inputs.tag }} \
            artifacts/kantra-rules-gen-linux-x64.bin \
            artifacts/kantra-rules-gen-macos-arm64.bin \
            artifacts/kantra-rules-gen-windows-x64.exe \
            artifacts/kantra-rules-gen.jar \
            README.md \
            --title "${{ inputs.tag }}" \
            --notes "## Kantra Rules Generator ${{ inputs.tag }}

          ### Downloads
          | Platform | File |
          |----------|------|
          | Linux x64 | kantra-rules-gen-linux-x64.bin |
          | macOS ARM64 | kantra-rules-gen-macos-arm64.bin |
          | Windows x64 | kantra-rules-gen-windows-x64.exe |
          | Uber JAR (Java 21+) | kantra-rules-gen.jar |

          ### Container
          \`\`\`bash
          docker pull quay.io/sshaaf/kantra-rules-gen:latest
          \`\`\`

          ### Documentation
          See [README.md](README.md) for usage instructions."
