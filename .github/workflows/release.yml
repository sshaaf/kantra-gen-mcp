name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2)'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get latest successful build run
        id: get-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list --branch main --workflow build.yml --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "No successful build found on main branch"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found successful run: $RUN_ID"

      - name: Download artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts
          gh run download ${{ steps.get-run.outputs.run_id }} --dir artifacts

      - name: Prepare release assets
        run: |
          cd artifacts
          # Use flexible glob patterns to handle any artifact naming
          cp scribe-linux-x64/*-runner scribe-linux-x64.bin
          cp scribe-macos/*-runner scribe-macos-arm64.bin
          cp scribe-windows-x64/*-runner.exe scribe-windows-x64.exe
          cp scribe-uber-jar/*-runner.jar scribe.jar
          ls -la *.bin *.exe *.jar

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ inputs.tag }} \
            artifacts/scribe-linux-x64.bin \
            artifacts/scribe-macos-arm64.bin \
            artifacts/scribe-windows-x64.exe \
            artifacts/scribe.jar \
            README.md \
            --title "${{ inputs.tag }}" \
            --notes "## Scribe ${{ inputs.tag }}

          ### Downloads
          | Platform | File |
          |----------|------|
          | Linux x64 | scribe-linux-x64.bin |
          | macOS ARM64 | scribe-macos-arm64.bin |
          | Windows x64 | scribe-windows-x64.exe |
          | Uber JAR (Java 21+) | scribe.jar |

          ### Container
          \`\`\`bash
          docker pull quay.io/sshaaf/scribe:latest
          \`\`\`

          ### Documentation
          See [README.md](README.md) for usage instructions."
